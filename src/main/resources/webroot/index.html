<!DOCTYPE html>
<html>
  <head>
    <title>Geosummly</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
    </style>
    <script src="js/jquery-2.0.3.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=drawing"></script>
    <script>

    function fromLatLngToPoint(latLng, map) {
	    var topRight = map.getProjection().fromLatLngToPoint(map.getBounds().getNorthEast());
	    var bottomLeft = map.getProjection().fromLatLngToPoint(map.getBounds().getSouthWest());
	    var scale = Math.pow(2, map.getZoom());
	    var worldPoint = map.getProjection().fromLatLngToPoint(latLng);
	    return new google.maps.Point((worldPoint.x - bottomLeft.x) * scale, (worldPoint.y - topRight.y) * scale);
    }
    
    function send (map, rectangle) {
      var bounds = rectangle.getBounds();
      var _ne = bounds.getNorthEast();
      var _sw = bounds.getSouthWest();
      var _nw = new google.maps.LatLng(_ne.lat(),_sw.lng());
      var _se = new google.maps.LatLng(_sw.lat(),_ne.lng());
      console.log("NE=" + _ne + "\nSW=" + _sw + "\nNW=" + _nw + "\nSE=" + _se); 

      console.log("height=" + google.maps.geometry.spherical.computeDistanceBetween(_ne,_se) + "m");
      console.log("width=" + google.maps.geometry.spherical.computeDistanceBetween(_ne,_nw) + "m");  
      
      //get x,y of the pixel
      console.log(fromLatLngToPoint(_nw,map));
 	  console.log(fromLatLngToPoint(_se,map));

      $.get( "/api/fingerprint", { north: _ne.lat(), south: _sw.lat(), 
                                   est: _ne.lng(), west: _sw.lng()} )
      .success(function( data ) {
          console.log( "Data fetched: " + data );
      })
      .fail(function() {
          console.log( "error" );
      });	  
    }

    function initialize() {
      var mapOptions = {
        center: new google.maps.LatLng(45.057, 7.6600),
        zoom: 10,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        draggable: false
      };

      var map = new google.maps.Map(document.getElementById('map-canvas'),
        mapOptions);

      var drawingManager = new google.maps.drawing.DrawingManager({
        //drawingMode: google.maps.drawing.OverlayType.MARKER,
        drawingControl: true,
        drawingControlOptions: {
          position: google.maps.ControlPosition.TOP_CENTER,
          drawingModes: [
            //google.maps.drawing.OverlayType.MARKER,
            //google.maps.drawing.OverlayType.CIRCLE,
            //google.maps.drawing.OverlayType.POLYGON,
            //google.maps.drawing.OverlayType.POLYLINE,
            google.maps.drawing.OverlayType.RECTANGLE
          ]
        },
        markerOptions: {
          icon: 'images/beachflag.png'
        },
        circleOptions: {
          fillColor: '#ffff00',
          fillOpacity: 1,
          strokeWeight: 5,
          clickable: false,
          editable: true,
          zIndex: 1
        },
        rectangleOptions: {
          fillColor: '#ffff00',
          editable: true,
          draggable: true
        }
      });


      google.maps.event.addListener(drawingManager, 'rectanglecomplete', 
        function(rectangle) {
          // Switch back to non-drawing mode after drawing a shape.
          drawingManager.setDrawingMode(null);

          //end dragged
          //google.maps.event.addListener(rectangle, 'dragend', console.log("yeah") );
          
          //end bounds changes
          //fix bug: http://code.google.com/p/gmaps-api-issues/issues/detail?id=1371
          var timeout;
          google.maps.event.addListener(rectangle, 'bounds_changed', function () {
          window.clearTimeout(timeout);
          timeout = window.setTimeout(function () {
              send(map, rectangle);
              }, 500);
          });

          send(map, rectangle);
        } ); 

      drawingManager.setMap(map);
    }

    google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body>
    <div id="map-canvas" height="100" width="200"></div>
  </body>
</html>